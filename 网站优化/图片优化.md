# 图片优化
根据业务需求，我们不可避免的会遇到加载图片的情况，因此图片的加载速率直接影响页面的加载速度。

一般遇到的图片加载问题分为以下两个方面：

* 启动页面加载的图片过多
* 图片体积过大

对于出现这种问题的原因主要是图片的请求是同时发出的，而对于同一个域名，浏览器可以同时处理的并发请求是有限制的，如 Chrome 浏览器可以同时处理 6 个并发请求，而其他的请求将会推入到队列中等待或者停滞不前，直到六个请求之一完成后，队列中新的请求才会发出。另一个原因就是图片体积过大，必然会导致下载时间变长。

## 解决方案
### 延迟首屏不需要的图片加载
打开一个页面，并不是需要将所有的图片都加载，而是加载首先进入屏幕视窗内区域的图片，而判断图片是否在首屏内，可以通过 getBoundingClientRect 方法，获取到图片的位置信息，判断其是否在 viewport 内部。

``` js
const inViewport = (el) => {
  const rect = el.getBoundingClientRect()

  return rect.top > 0
    && rect.bottom < window.innerHeight
    && rect.left > 0
    && rect.right < window.innerWidth
}
```

### 压缩图片大小
在保证清晰度的前提下尽量使用体积较小的图片。而一张图片的体积由两个因素决定，该图片总的像素数目和编码单位像素所需的字节数。因此一张图片的文件大小就等于图片总像素数目乘以编码单位像素所需字节数。

如：一张 100px * 100px 像素的图片，其包含该 100 * 100 = 10000 个像素点，而每个像素点通过 RGBA 颜色值进行存储，R\G\B\A 每个色道都有 0~255 个取值，也就是 2^8 = 256。正好是 8 位 1byte。而每个像素点有四个色道，每个像素点需要 4bytes。因此该图片体积为：10000 * 4bytes = 40000bytes = 39KB。

所以压缩图片大小分为两个方向：

* 一是减少单位像素所需的字节数；
* 二是减少一张图片总的像素个数。

#### 单位像素优化
针对单位像素的优化，衍生出了不同的图片格式，jpeg、png、gif、webp。不同的图片格式都有自己的减少单位像素体积的算法。同时也有各自的优势和劣势，比如 jpeg 和 png 不支持动画效果，jpeg 图片体积小但是不支持透明度等。推荐使用的 google 推出的 webp 格式，相对 jpeg ，体积减少 30%，同时还支持动画和透明度。

#### 图片像素总数优化
根据设备的尺寸来加载不同尺寸（像素总数不同）的图片，也就是说在保证图片清晰度的前提下，尽量使用体积小的图片。

## 图片加载优化
### 线性加载
图片的加载方式由上至下, 一点一点的加载。

比如在 Photoshop 中, 我们使用快捷键 `ctrl + shift + alt + s`, 弹出储存为 Web 所用格式, 再选择 jpeg 格式后能看到下面有一个连续的选项(悬浮提示以多条路径下载), 这个选项的背后就是一个算法的接口，默认是不勾选的。渐进式使用的是小波变换, 而默认线性加载则是离散余弦变化算法。


### 渐进式加载
它会先显示低分辨率的近似图像, 再逐步的增加图片分辨率(模糊到清晰)。